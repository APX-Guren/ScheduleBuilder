name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Cordova
        run: npm install -g cordova

      - name: Install Dependencies
        run: npm install

      # 1. Add Android Platform (Creates all the files)
      - name: Add Android Platform
        run: cordova platform add android

      # --- FINAL GRADLE FIX: TARGETING THE PRIMARY BUILD FILE ---
      # This step is the LAST attempt to manually override the version 
      # before the build command crashes. We target the file that specifies the required Gradle version.
      - name: Fix Gradle Version in Project Build File
        run: |
          BUILD_GRADLE_PATH="platforms/android/build.gradle"
          
          # Check if the file exists after platform add (it should always exist)
          if [ -f "$BUILD_GRADLE_PATH" ]; then
            echo "--- Forcing Gradle Version to 8.7 ---"
            
            # This sed command inserts the version property needed to override the default.
            # We are modifying the main build.gradle file to declare a custom wrapper.
            sed -i '/apply from: "cordova-common.gradle"/a \ 
            ext.cli.gradle = "8.7"' $BUILD_GRADLE_PATH
            
            echo "--- Gradle Version Override Applied ---"
          else
            echo "ERROR: Could not find $BUILD_GRADLE_PATH. Manual intervention may be required."
            exit 1 
          fi
      # -------------------------------------------------------------

      - name: Build APK
        run: cordova build android --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: schedule-app-debug
          path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
